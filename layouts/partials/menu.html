{{- $currentNode := . }}
{{- $showvisitedlinks := .Site.Params.showVisitedLinks -}}
{{- $isParentRoot := eq .Parent .FirstSection -}}
{{- $numOfChildren := (add (len .Pages) (len .Sections)) -}}
{{- $shouldCollapse := and $isParentRoot (eq $numOfChildren 0) -}}
{{- $isCollapsed := (or $shouldCollapse (or (eq .URL "/rs/") (eq .URL "/rc/") (eq .URL "/rv/") (eq .URL "/platforms/") (eq .URL "/ri/") (eq .URL "/modules/"))) -}}

{{- if eq .Site.Params.ordersectionsby "title"}}
  {{- range .Site.Home.Sections.ByTitle}}
  {{- template "section-tree-nav" dict "sect" . "currentnode" $currentNode "showvisitedlinks" $showvisitedlinks "isCollapsed" $isCollapsed}}
  {{- end}}
{{- else}}
  {{- range .Site.Home.Sections.ByWeight}}
  {{- template "section-tree-nav" dict "sect" . "currentnode" $currentNode "showvisitedlinks" $showvisitedlinks "isCollapsed" $isCollapsed}}
  {{- end}}
{{- end}}

<!-- templates -->
{{- define "section-tree-nav"}}
{{- $showvisitedlinks := .showvisitedlinks }}
{{- $isCollapsed := .isCollapsed }}
{{- $currentNode := .currentnode }}
 {{- with .sect}}
  {{- if and .IsSection (or (not .Params.hidden) $.showhidden)}}
    {{- $numberOfPages := (add (len .Pages) (len .Sections)) }}
    {{- safeHTML .Params.head}}    
    <li data-nav-id="{{.URL}}" class="dd-item
        {{- if .IsAncestor $currentNode}} parent{{end -}}
        {{- if eq .URL $currentNode.URL}} active{{end -}}
        {{- if .Params.alwaysopen}} alwaysopen{{end -}}
        {{- if ne $numberOfPages 0 }} haschildren{{end -}}
        {{- if $isCollapsed}} menu-collapsed {{else}} menu-expanded{{end -}}
        {{- if (or (eq .URL "/rs/") (eq .URL "/rc/") (eq .URL "/rv/") (eq .URL "/platforms/") (eq .URL "/ri/") (eq .URL "/modules/"))}} menu-root {{end}}
        ">
        {{- if or (eq .RelPermalink "/rs/") (eq .RelPermalink "/rc/") (eq .RelPermalink "/rv/") (eq .RelPermalink "/platforms/") (eq .RelPermalink "/ri/") (eq .URL "/modules/")}}
          <a href="{{ .RelPermalink}}">{{safeHTML .Params.Pre}}{{.Title}}{{safeHTML .Params.Post}}</a>          
        {{- end}}

        {{- if eq .URL .RelPermalink }}
          <!-- Child items -->          
          {{if or (eq .URL "/rs/") }}
            <div class="children has-version-selector">
          {{else}}
            <div class="children">
          {{end}}

              {{- if or (eq .URL "/rs/") (eq .URL "/rc/") (eq .URL "/rv/") (eq .URL "/platforms/") (eq .URL "/ri/") (eq .URL "/modules/")}}          
                <div class="menu-divider"></div>
                
                <span class="SideMenuToggle expander">
                  <a class="expander-title">
                    <span class="SideMenuExpanderTitle expand-all-title">Expand all</span>
                    <span class="SideMenuExpanderTitle collapse-all-title">Collapse all</span>
                  </a>
                  <i class="fa fa-angle-double-down fa-lg expand-all-icon"></i>
                  <i class="fa fa-angle-double-up fa-lg collapse-all-icon"></i>
                </span>                

              {{- else}}
                <a href="{{ .RelPermalink}}">{{safeHTML .Params.Pre}}{{.Title}}{{safeHTML .Params.Post}}</a>

                {{- if ne $numberOfPages 0 }}
                  {{- if or (.IsAncestor $currentNode) (.Params.alwaysopen) }}
                    <i class="fa fa-angle-down fa-lg category-icon"></i>
                  {{- else -}}
                    <i class="fa fa-angle-right fa-lg category-icon"></i>
                  {{- end}}
                {{- end}}                
              {{- end}}
            
            {{- if $showvisitedlinks}}<i class="fa fa-circle-thin read-icon"></i>{{end}}
          </div>
        {{- end}}

      {{- if ne $numberOfPages 0 }}
        <ul>
          {{- .Scratch.Set "pages" .Pages }}
          {{- if .Sections}}
          {{- .Scratch.Set "pages" (.Pages | union .Sections) }}
          {{- end}}
          {{- $pages := (.Scratch.Get "pages") }}

        {{- if eq .Site.Params.ordersectionsby "title"}}
          {{- range $pages.ByTitle }}
            {{- if and .Params.hidden (not $.showhidden) }}
            {{- else}}
            {{- template "section-tree-nav" dict "sect" . "currentnode" $currentNode "showvisitedlinks" $showvisitedlinks "isCollapsed" $isCollapsed }}
            {{- end}}
          {{- end}}
        {{- else}}
          {{- range $pages.ByWeight }}
            {{- if and .Params.hidden (not $.showhidden) }}
            {{- else}}
            {{- template "section-tree-nav" dict "sect" . "currentnode" $currentNode "showvisitedlinks" $showvisitedlinks "isCollapsed" $isCollapsed }}
            {{- end}}
          {{- end}}
        {{- end}}
        </ul>
      {{- end}}
    </li>
  {{- else}}
    {{- if not .Params.Hidden }}
      <li data-nav-id="{{.URL}}" class="dd-item
     {{- if eq .URL $currentNode.URL}} active{{end -}}
      ">
        <div>
          <a href="{{ .RelPermalink}}">
            {{safeHTML .Params.Pre}}{{.LinkTitle}}{{safeHTML .Params.Post}}
          </a>
          {{- if $showvisitedlinks}}<i class="fa fa-circle-thin read-icon"></i>{{end}}
        </div>
    </li>
     {{- end}}
  {{- end}}
 {{- end}}
{{- end}}
